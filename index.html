<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sincronización Total | Minecrafteanos</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
    <style>
        :root { --mc-green: #3aa03a; --mc-accent: #ffcc00; }
        body { 
            background: #111 url('https://i.pinimg.com/1200x/b1/61/86/b16186708349ead1e9fa67b03d4062c2.jpg') no-repeat center center fixed;
            background-size: cover; color: white; font-family: sans-serif; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }
        header { background: rgba(20,20,20,0.9); padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 4px solid #000; }
        nav { display: flex; background: #222; border-bottom: 2px solid #000; }
        nav span { flex: 1; text-align: center; padding: 12px; cursor: pointer; font-family: 'VT323', monospace; font-size: 1.2rem; color: #888; }
        nav span.active { color: var(--mc-accent); background: #333; border-bottom: 3px solid var(--mc-accent); }
        .content { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 80px; }
        #tab-chat { display: none; }
        #tab-chat.active { display: block; }
        .msg { background: rgba(0,0,0,0.85); padding: 10px; margin-bottom: 8px; border-left: 4px solid var(--mc-green); display: flex; gap: 10px; border-radius: 4px; animation: pop 0.2s ease-out; }
        .msg.me { border-left: 0; border-right: 4px solid var(--mc-accent); flex-direction: row-reverse; }
        .msg img { width: 35px; height: 35px; border: 1px solid #555; image-rendering: pixelated; }
        @keyframes pop { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .input-area { position: fixed; bottom: 0; left: 0; right: 0; padding: 10px; background: #111; display: flex; gap: 10px; border-top: 2px solid #000; }
        input { flex: 1; padding: 12px; background: #000; color: #55ff55; border: 2px solid #555; font-family: monospace; outline: none; }
        .mc-btn { background: #555; border: 2px solid #000; border-top-color: #888; border-left-color: #888; color: white; padding: 5px 15px; cursor: pointer; font-family: 'VT323', monospace; }
        #auth-screen { position: fixed; inset: 0; z-index: 100; background: #000; display: flex; align-items: center; justify-content: center; flex-direction: column; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <h1 style="font-family:'VT323'; color:var(--mc-green); font-size:3rem">MINE-LOGIN</h1>
        <div style="width:250px">
            <input type="text" id="user" placeholder="Usuario">
            <input type="password" id="pass" placeholder="Clave">
            <button class="mc-btn" style="width:100%; margin-top:10px" onclick="auth()">ENTRAR / REGISTRAR</button>
        </div>
        <p id="auth-log" style="font-size:10px; color:#444; margin-top:20px">Esperando servidores...</p>
    </div>

    <header>
        <div style="display:flex; align-items:center; gap:10px">
            <span style="font-family:'VT323'; color:var(--mc-green); font-size:1.5rem">MINECRAFTEANOS</span>
            <div id="dot" style="width:10px; height:10px; background:red; border-radius:50%"></div>
        </div>
        <div id="my-name" style="font-family:'VT323'; color:var(--mc-accent)"></div>
    </header>

    <nav>
        <span id="btn-news" class="active" onclick="tab('news')">NOTICIAS</span>
        <span id="btn-chat" onclick="tab('chat')">CHAT GLOBAL</span>
    </nav>

    <div id="tab-news" class="content" style="display:block">
        <div style="background:rgba(0,0,0,0.5); padding:20px; border:2px solid #333; text-align:center">
            <h2 style="font-family:'VT323'">¡BIENVENIDO!</h2>
            <p>Si estás en 3 dispositivos, escribe en uno y mira cómo aparece en los otros.</p>
        </div>
    </div>

    <div id="tab-chat" class="content">
        <div id="msgs"></div>
    </div>

    <div id="chat-bar" class="input-area" style="display:none">
        <input type="text" id="m-input" placeholder="Escribe..." onkeypress="if(event.key==='Enter') send()">
        <button class="mc-btn" onclick="send()">ENVIAR</button>
    </div>

    <script>
        // PEERS REDUNDANTES (La clave de la sincronización)
        const gun = Gun({
            peers: [
                'https://gun-manhattan.herokuapp.com/gun',
                'https://peer.wall.org/gun',
                'https://relay.peer.ooo/gun'
            ]
        });

        const user = gun.user().recall({storage: true});
        const chat = gun.get('mine_chat_v_definitiva_100'); // Base de datos limpia

        // Actualizar estado de conexión
        gun.on('hi', () => { 
            document.getElementById('dot').style.background = '#55ff55';
            document.getElementById('auth-log').innerText = "Servidores conectados.";
        });

        function auth() {
            const u = document.getElementById('user').value;
            const p = document.getElementById('pass').value;
            if(!u || !p) return alert("Llena los campos");
            
            // Intentar login, si falla, crear cuenta automáticamente
            user.auth(u, p, (ack) => {
                if(ack.err) {
                    user.create(u, p, (s) => {
                        if(s.err) alert("Error: " + s.err);
                        else auth();
                    });
                } else {
                    go();
                }
            });
        }

        function go() {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('my-name').innerText = user.is.alias;
            listen();
        }

        if(user.is) go();

        function send() {
            const i = document.getElementById('m-input');
            if(!i.value.trim()) return;
            
            // Publicamos el mensaje
            chat.set({
                name: user.is.alias,
                text: i.value,
                time: Date.now()
            });
            
            // "Pulso de fuerza" para obligar a los otros dispositivos a recibir datos
            gun.get('ping').put({ time: Date.now() }); 
            
            i.value = "";
        }

        function listen() {
            const box = document.getElementById('msgs');
            // Usamos .map().on para escuchar cambios constantes
            chat.map().on((data, id) => {
                if(!data || !data.text || document.getElementById(id)) return;
                
                const isMe = data.name === user.is.alias;
                const div = document.createElement('div');
                div.id = id;
                div.className = `msg ${isMe ? 'me' : ''}`;
                div.innerHTML = `
                    <img src="https://mc-heads.net/avatar/${data.name}">
                    <div>
                        <b style="color:var(--mc-accent); font-size:12px">${data.name}</b>
                        <div>${data.text}</div>
                    </div>
                `;
                box.appendChild(div);
                document.getElementById('tab-chat').scrollTop = document.getElementById('tab-chat').scrollHeight;
            });
        }

        function tab(t) {
            document.getElementById('tab-news').style.display = t === 'news' ? 'block' : 'none';
            document.getElementById('tab-chat').className = t === 'chat' ? 'content active' : 'content';
            document.getElementById('btn-news').className = t === 'news' ? 'active' : '';
            document.getElementById('btn-chat').className = t === 'chat' ? 'active' : '';
            document.getElementById('chat-bar').style.display = t === 'chat' ? 'flex' : 'none';
            if(t === 'chat') document.getElementById('tab-chat').scrollTop = document.getElementById('tab-chat').scrollHeight;
        }

        // EL "HEARTBEAT" (Prueba de fuego para la IA)
        // Cada 10 segundos, este código envía un pequeño dato invisible.
        // Esto mantiene los sockets abiertos en móviles y PC sin que el navegador los duerma.
        setInterval(() => {
            if(user.is) gun.get('heartbeat').put({ pulse: Date.now() });
        }, 10000);
    </script>
</body>
</html>
