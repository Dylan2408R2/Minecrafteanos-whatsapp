<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creeper P2P Chat - CAOS EDITION</title>
    <link href="https://fonts.cdnfonts.com/css/minecraft-4" rel="stylesheet">
    <!-- LibrerÃ­a para conexiÃ³n directa entre navegadores -->
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        :root { --mc-green: #52ad32; --mc-dark: #1a1a1a; --mc-gui: #c6c6c6; }
        body { background-color: var(--mc-dark); color: white; font-family: 'Minecraft', sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; overflow: hidden; }
        
        .box { background: #4a4a4a; border: 5px solid #000; padding: 20px; box-shadow: 10px 10px 0px var(--mc-green); text-align: center; max-width: 500px; width: 90%; }
        
        input { font-family: 'Minecraft', sans-serif; padding: 10px; border: 3px solid #000; background: #222; color: #00ff00; margin: 5px; outline: none; width: 80%; }
        
        button { font-family: 'Minecraft', sans-serif; background: var(--mc-gui); border: 3px solid #fff; border-right-color: #555; border-bottom-color: #555; padding: 10px 20px; cursor: pointer; margin: 5px; }
        button:hover { background: #eee; }

        #chat-screen { display: none; width: 95%; max-width: 800px; height: 90vh; flex-direction: column; }
        #messages { flex-grow: 1; background: rgba(0,0,0,0.8); border: 4px solid var(--mc-gui); margin-bottom: 10px; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; text-align: left; }
        
        .msg { background: #333; padding: 10px; border-left: 5px solid var(--mc-green); font-size: 1.2rem; }
        .msg b { color: var(--mc-green); display: block; font-size: 0.8rem; }

        /* ENGINE CREEPER ANIMADO */
        .creeper { display: inline-block; width: 32px; height: 32px; vertical-align: middle; background-color: #52ad32; background-size: 100% 100%; image-rendering: pixelated; margin: 0 2px; }
        .anim-bounce { animation: bounce 1s infinite; }
        .anim-angry { animation: flash 0.4s infinite alternate, shake 0.1s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes flash { from { background-color: #52ad32; } to { background-color: #ff3333; } }
        @keyframes shake { 0% { transform: translate(1px); } 100% { transform: translate(-1px); } }
    </style>
</head>
<body>

    <!-- PASO 1: LOGIN -->
    <div id="login-step" class="box">
        <h1 style="color: var(--mc-green);">CREEPER CHAT</h1>
        <input type="text" id="username" placeholder="Tu nombre de usuario...">
        <br>
        <button onclick="startConnection()">SIGUIENTE</button>
    </div>

    <!-- PASO 2: CONEXIÃ“N -->
    <div id="connect-step" class="box" style="display:none;">
        <h2 id="my-id-display">Generando ID...</h2>
        <p style="font-size: 0.7rem;">DALE ESTE ID A TUS AMIGOS:</p>
        <input type="text" id="peer-id-input" readonly onclick="this.select()">
        <hr>
        <p style="font-size: 0.7rem;">O PEGA EL ID DE UN AMIGO:</p>
        <input type="text" id="dest-id-input" placeholder="ID del amigo...">
        <br>
        <button onclick="connectToFriend()">CONECTARSE</button>
    </div>

    <!-- PASO 3: CHAT -->
    <div id="chat-screen">
        <div id="messages"></div>
        <div style="display:flex;">
            <input type="text" id="msg-input" placeholder="Escribe un mensaje...">
            <button onclick="sendMsg()">ENVIAR</button>
        </div>
    </div>

    <script>
        let peer, conn, myName;
        const msgInput = document.getElementById('msg-input');
        const messagesDiv = document.getElementById('messages');

        // 1. Iniciar PeerJS
        function startConnection() {
            myName = document.getElementById('username').value;
            if(!myName) return alert("PonÃ© un nombre!");

            peer = new Peer(); // PeerJS usa sus propios servidores gratuitos para encontrarnos
            
            peer.on('open', (id) => {
                document.getElementById('login-step').style.display = 'none';
                document.getElementById('connect-step').style.display = 'block';
                document.getElementById('peer-id-input').value = id;
                document.getElementById('my-id-display').innerText = "TU ID: " + id.substring(0,5);
            });

            // Escuchar conexiones entrantes (si vos sos el Host)
            peer.on('connection', (connection) => {
                conn = connection;
                setupChat();
            });
        }

        // 2. Conectarse a alguien
        function connectToFriend() {
            const destId = document.getElementById('dest-id-input').value;
            conn = peer.connect(destId);
            setupChat();
        }

        function setupChat() {
            document.getElementById('connect-step').style.display = 'none';
            document.getElementById('chat-screen').style.display = 'flex';

            conn.on('data', (data) => {
                renderMsg(data.user, data.text);
            });
            
            conn.on('open', () => {
                renderMsg("SISTEMA", "Â¡Conectado con Ã©xito!");
            });
        }

        // 3. Sistema de Emojis Creeperizado
        function creeperize(texto) {
            const faces = {
                "ğŸ¤©": "stars", "ğŸ˜": "stars", "ğŸ˜¯": "surprise", 
                "ğŸ˜­": "sad", "ğŸ˜ ": "angry", "ğŸ˜€": "happy"
            };
            const todos = ["ğŸ¤£","ğŸ˜…","ğŸ˜Š","ğŸ˜—","â˜º","ğŸ¤©","ğŸ˜","ğŸ™„","ğŸ˜¥","ğŸ˜¯","ğŸ¥±","ğŸ˜›","ğŸ¤¤","ğŸ˜”","ğŸ¤‘","ğŸ™","ğŸ˜Ÿ","ğŸ˜­","ğŸ˜¨","ğŸ˜¬","ğŸ¥µ","ğŸ¤ª","ğŸ˜ ","ğŸ˜·","ğŸ¤¢","ğŸ˜‡","ğŸ¤ ","ğŸ¤«","ğŸ¤“"];

            for (const [emoji, tipo] of Object.entries(faces)) {
                let anim = tipo === "angry" ? "anim-angry" : "anim-bounce";
                const img = getCreeperFaceSVG(tipo);
                texto = texto.split(emoji).join(`<span class="creeper ${anim}" style='background-image: ${img}'></span>`);
            }
            todos.forEach(emoji => {
                const img = getCreeperFaceSVG("normal");
                texto = texto.split(emoji).join(`<span class="creeper anim-bounce" style='background-image: ${img}'></span>`);
            });
            return texto;
        }

        function getCreeperFaceSVG(tipo) {
            let eyes = "M1,1 h2 v2 h-2 z M5,1 h2 v2 h-2 z";
            let mouth = "M3,3 h2 v3 h-2 z M2,4 h1 v3 h-1 z M5,4 h1 v3 h-1 z";
            let ex = "";
            if (tipo === "surprise") mouth = "M3,4 h2 v3 h-2 z M2,6 h4 v1 h-4 z";
            if (tipo === "stars") {
                ex = `<rect x="1" y="1" width="2" height="2" fill="%23b0b0ff"/><path d="M1,2 h2 M2,1 v2" stroke="white" stroke-width="0.5"/><rect x="5" y="1" width="2" height="2" fill="%23b0b0ff"/><path d="M5,2 h2 M6,1 v2" stroke="white" stroke-width="0.5"/>`;
                eyes = "";
            }
            if (tipo === "sad") ex = `<path d="M1,3 h1 v3 h-1 z M6,3 h1 v3 h-1 z" fill="%2300eeff"/>`;
            if (tipo === "happy") mouth = "M1,4 h1 v2 h-1 z M6,4 h1 v2 h-1 z M2,6 h4 v1 h-4 z";

            const svg = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8' shape-rendering='crispEdges'><path d='${eyes}' fill='black'/><path d='${mouth}' fill='black'/>${ex}</svg>`;
            return `url("data:image/svg+xml;base64,${btoa(svg)}")`;
        }

        // 4. Enviar y Renderizar
        function sendMsg() {
            const text = msgInput.value;
            if(!text || !conn) return;
            conn.send({ user: myName, text: text });
            renderMsg("VOS", text);
            msgInput.value = "";
        }

        function renderMsg(user, text) {
            const div = document.createElement('div');
            div.className = "msg";
            div.innerHTML = `<b>${user}</b> <span>${creeperize(text)}</span>`;
            messagesDiv.appendChild(div);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        msgInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') sendMsg(); });
    </script>
</body>
</html>
