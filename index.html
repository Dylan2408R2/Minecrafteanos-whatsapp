<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creeper Chat - Share Edition</title>
    <link href="https://fonts.cdnfonts.com/css/minecraft-4" rel="stylesheet">
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        :root { --green: #52ad32; --dark: #1a1a1a; --gui: #c6c6c6; }
        body { background-color: var(--dark); color: white; font-family: 'Minecraft', sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; overflow: hidden; user-select: none; }
        .window { background: #4a4a4a; border: 5px solid #000; padding: 25px; box-shadow: 10px 10px 0px var(--green); text-align: center; width: 90%; max-width: 500px; }
        
        /* Tabs */
        .tabs { display: flex; gap: 5px; margin-bottom: 20px; }
        .tab { flex: 1; padding: 10px; background: #333; border: 3px solid #000; cursor: pointer; color: #888; font-size: 0.8rem; }
        .tab.active { background: var(--gui); color: #000; border-bottom: none; }

        input { font-family: 'Minecraft', sans-serif; padding: 12px; border: 3px solid #000; background: #111; color: #00ff00; margin: 5px 0; width: 90%; box-sizing: border-box; outline: none; }
        button { font-family: 'Minecraft', sans-serif; background: var(--gui); border: 3px solid #fff; border-right-color: #555; border-bottom-color: #555; padding: 12px 24px; cursor: pointer; }
        button:active { border: 3px solid #555; border-right-color: #fff; border-bottom-color: #fff; }

        /* Dino */
        #game-container { width: 100%; height: 130px; background: #222; border: 3px solid #000; margin: 15px 0; display: none; overflow: hidden; }
        #loading-screen { display: none; flex-direction: column; align-items: center; }

        /* Share Group */
        .share-group { display: flex; gap: 5px; margin-top: 5px; justify-content: center; width: 90%; margin-left: auto; margin-right: auto; }
        .btn-small { padding: 8px 10px; font-size: 0.7rem; flex: 1; }

        /* Chat */
        #chat-screen { display: none; width: 95%; max-width: 900px; height: 90vh; flex-direction: column; }
        #messages { flex-grow: 1; background: rgba(0,0,0,0.9); border: 4px solid var(--gui); margin-bottom: 10px; overflow-y: auto; padding: 20px; }
        .msg-row { display: flex; gap: 12px; margin-bottom: 15px; text-align: left; }
        .avatar { width: 48px; height: 48px; border: 3px solid #000; image-rendering: pixelated; }
        .msg-box { background: #333; padding: 10px; border-left: 4px solid var(--green); flex: 1; }

        /* Emojis */
        .creeper-emoji { display: inline-block; width: 32px; height: 32px; vertical-align: middle; background-size: 100% 100%; image-rendering: pixelated; margin: 0 3px; background-color: var(--green); animation: bounce 1s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
    </style>
</head>
<body>

    <!-- PANTALLA DE CUENTAS -->
    <div id="auth-screen" class="window">
        <h1 style="color: var(--green); margin-top: 0;">CREEPER NET</h1>
        <div class="tabs">
            <div id="tab-login" class="tab active" onclick="setTab('login')">LOGIN</div>
            <div id="tab-reg" class="tab" onclick="setTab('reg')">REGISTRO</div>
        </div>
        <input type="text" id="user" placeholder="Usuario NameMC" oninput="prevSkin()">
        <img id="skin-p" src="https://mc-heads.net/avatar/Steve" style="width: 50px; margin: 10px; border: 2px solid #000; image-rendering: pixelated;">
        <input type="password" id="pass" placeholder="Contrase√±a">
        <br>
        <button id="auth-btn" onclick="handleAuth()">ENTRAR AL MUNDO</button>
    </div>

    <!-- CARGA + DINO -->
    <div id="loading-screen" class="window">
        <h2>CARGANDO CHAT...</h2>
        <div id="game-container"><canvas id="game-canvas"></canvas></div>
        <p style="font-size: 0.6rem;">SALTA TNT CON ESPACIO</p>
        <div style="width:100%; height:12px; background:#111; border:2px solid #000;">
            <div id="bar" style="width:0%; height:100%; background:var(--green); transition:0.3s;"></div>
        </div>
    </div>

    <!-- CONEXI√ìN -->
    <div id="connect-step" class="window" style="display:none;">
        <h2 style="color:var(--green)">MUNDO LISTO</h2>
        <p style="font-size: 0.7rem;">TU ID PARA COMPARTIR:</p>
        <input type="text" id="my-id" readonly style="color: white; text-align: center;">
        
        <div class="share-group">
            <button class="btn-small" onclick="copyID()">COPIAR</button>
            <button class="btn-small" onclick="shareID()">COMPARTIR</button>
        </div>

        <hr style="border:1px solid #555; margin: 20px 0;">
        <p style="font-size: 0.7rem;">PEGA EL ID DE TU AMIGO:</p>
        <input type="text" id="peer-id-input" placeholder="ID aqu√≠...">
        <br>
        <button onclick="connectToFriend()">CONECTARSE</button>
    </div>

    <!-- CHAT -->
    <div id="chat-screen">
        <div id="messages"></div>
        <div style="display:flex; gap:10px;">
            <input type="text" id="msg-input" placeholder="Escribe algo..." style="margin:0;">
            <button onclick="sendMsg()" style="margin:0;">ENVIAR</button>
        </div>
    </div>

    <script>
        let mode = 'login';
        let peer, conn, myName, myAvatar, gameOn = false;

        function setTab(t) {
            mode = t;
            document.getElementById('tab-login').classList.toggle('active', t === 'login');
            document.getElementById('tab-reg').classList.toggle('active', t === 'reg');
            document.getElementById('auth-btn').innerText = t === 'login' ? 'ENTRAR AL MUNDO' : 'CREAR CUENTA';
        }

        function prevSkin() {
            const u = document.getElementById('user').value;
            document.getElementById('skin-p').src = u ? `https://mc-heads.net/avatar/${u}` : `https://mc-heads.net/avatar/Steve`;
        }

        function handleAuth() {
            const u = document.getElementById('user').value.trim().toLowerCase();
            const p = document.getElementById('pass').value;
            if(!u || !p) return alert("¬°Datos incompletos!");

            const accounts = JSON.parse(localStorage.getItem('creeper_accounts') || '{}');

            if(mode === 'reg') {
                if(accounts[u]) return alert("Usuario ya registrado.");
                accounts[u] = p;
                localStorage.setItem('creeper_accounts', JSON.stringify(accounts));
                alert("¬°Cuenta creada! Logueate.");
                setTab('login');
            } else {
                if(accounts[u] !== p) return alert("Error de credenciales.");
                myName = u;
                myAvatar = `https://mc-heads.net/avatar/${u}`;
                startLoading();
            }
        }

        // --- ID TOOLS ---
        function copyID() {
            const idVal = document.getElementById('my-id').value;
            navigator.clipboard.writeText(idVal).then(() => {
                alert("ID Copiado");
            });
        }

        function shareID() {
            const idVal = document.getElementById('my-id').value;
            if (navigator.share) {
                navigator.share({
                    text: idVal // Solo el ID, nada m√°s
                }).catch(() => {});
            } else {
                copyID(); // Fallback si el navegador no soporta share
            }
        }

        // --- CARGA ---
        function startLoading() {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('loading-screen').style.display = 'flex';
            document.getElementById('game-container').style.display = 'block';
            
            initDino();
            peer = new Peer();
            peer.on('open', id => {
                document.getElementById('bar').style.width = "100%";
                setTimeout(() => {
                    gameOn = false;
                    document.getElementById('loading-screen').style.display = 'none';
                    document.getElementById('connect-step').style.display = 'block';
                    document.getElementById('my-id').value = id;
                }, 1000);
            });
            peer.on('connection', c => { conn = c; openChat(); });
        }

        function initDino() {
            const canvas = document.getElementById('game-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 500; canvas.height = 130;
            let cy = 90, cv = 0, obs = [];
            gameOn = true;
            function loop() {
                if(!gameOn) return;
                ctx.fillStyle = "#222"; ctx.fillRect(0,0,500,130);
                cv += 0.8; cy += cv; if(cy > 90) { cy = 90; cv = 0; }
                ctx.fillStyle = "#52ad32"; ctx.fillRect(40, cy, 30, 30);
                if(Math.random() < 0.02) obs.push(500);
                obs.forEach((x,i) => {
                    obs[i] -= 7; ctx.fillStyle = "red"; ctx.fillRect(x, 100, 25, 25);
                    if(x < 70 && x > 20 && cy > 75) obs = [];
                });
                obs = obs.filter(x => x > -30);
                requestAnimationFrame(loop);
            }
            window.onkeydown = e => { if(e.code === 'Space' && cy === 90) cv = -13; };
            loop();
        }

        function connectToFriend() {
            const id = document.getElementById('peer-id-input').value.trim();
            conn = peer.connect(id);
            openChat();
        }

        function openChat() {
            document.getElementById('connect-step').style.display = 'none';
            document.getElementById('chat-screen').style.display = 'flex';
            conn.on('data', d => addMsg(d.u, d.t, d.a));
        }

        function sendMsg() {
            const i = document.getElementById('msg-input');
            const d = { u: myName, t: i.value, a: myAvatar };
            conn.send(d); addMsg(myName, i.value, myAvatar); i.value = "";
        }

        function addMsg(u, t, a) {
            const messages = document.getElementById('messages');
            const div = document.createElement('div'); div.className = "msg-row";
            div.innerHTML = `<img src="${a}" class="avatar" onerror="this.src='https://mc-heads.net/avatar/Steve'"><div class="msg-box"><b>${u}</b><br>${creeperize(t)}</div>`;
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
        }

        function creeperize(t) {
            const faces = { "ü§©":"stars", "üòç":"stars", "üòØ":"surprise", "üò≠":"sad", "üò†":"angry", "üòÄ":"happy" };
            for(let [e, tipo] of Object.entries(faces)) {
                let svg = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8' shape-rendering='crispEdges'><path d='M1,1 h2 v2 h-2 z M5,1 h2 v2 h-2 z' fill='black'/><path d='M3,3 h2 v3 h-2 z M2,4 h1 v3 h-1 z M5,4 h1 v3 h-1 z' fill='black'/>${tipo==='sad'?'<path d="M1,3 h1 v3 h-1 z M6,3 h1 v3 h-1 z" fill="%2300eeff"/>':''}</svg>`;
                t = t.split(e).join(`<span class="creeper-emoji" style="background-image:url('data:image/svg+xml;base64,${btoa(svg)}')"></span>`);
            }
            return t;
        }
    </script>
</body>
</html>
